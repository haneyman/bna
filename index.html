<!doctype html>
<html xmlns="http://www.w3.org/1999/html">
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width" />
<title>BartNapApp</title>
<!--<link rel="stylesheet" href="assets/css/master.css" type="text/css" media="screen" />-->
<link rel="stylesheet" href="assets/css/jquery.mobile-1.1.1.min.css" type="text/css" media="screen" />
<script src="phonegap.js" type="text/javascript" charset="utf-8"></script>
<script src="assets/js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
<script src="assets/js/jquery.mobile-1.1.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="assets/js/jquery.csv.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
    var MINUTES_BEFORE_ARRIVAL = 5;
    var isAlarmOn = false; //off, on, ??
    var alarmType = 1; //0=none, 1=alarm, 2=vibrate, 3=both
    var stationDepartAbbr = "";
    var stationArriveAbbr = "";
    var tripTime;//in seconds
    var departTime;//Date of when train leaves the Start
    var arriveTime;//Date of when train arrives at End
    var url = "";
    var bartApiResult;
    var BART_API_KEY = "&key=UBHV-T2TG-U2UQ-2VA5";
    var arrayStopTimes = [];
    var arrayStations  = [];
    var timeout;//holds setTimeout
    var alarmFileURL = "assets/audio/alarmBig.mp3";
    var alarmAudio;//for audio instance
    //
    var isDebug = true;
    var stopTimesFilenameURL = "gtfs/stop_times.txt";
    //var stopTimesFilenameURL = "gtfs/stop_times_test.txt";
    //

    $(document).ready(function(){
    //                $( "#progressbar" ).progressbar({
    //                    value: 0
    //                });
        log("Docready starting...")
        $('#departProgress').hide();
        $('#debugLog').hide();


        $("[name=radio-alarm-state]").change(function() {
            isAlarmOn = $('#radio-alarm-on').attr("checked")=="checked";
            log("Alarm switched to " + isAlarmOn);
            if (isAlarmOn)
                alarmOn();
            else
                alarmOff();
        });

        $("[name=radio-alarmtype]").change(function() {
            if ( $('#radio-alarmtype-noise').attr("checked")=="checked")
                alarmType = 1;
            else if ( $('#radio-alarmtype-vibrate').attr("checked")=="checked")
                alarmType = 2;
            else
                alarmType = 3;
            log("Alarm type is now" + alarmType);
        });

        $('#select-depart').change(function() {
            newTrip();
        });
        $('#select-arrive').change(function() {
            newTrip();
        });

        //initializations
        //$('#debugLog').trigger( "expand" );
        //switchAlarm(false);
        loadStations();
        loadStopTimes();
        $("#select-depart option:selected").val("");//TODO:not working, says "North Concord"
        $("#select-arrive option:selected").val("");
        alarmOff();
        log("Docready complete")
    });



    document.addEventListener("deviceready", onDeviceReady, false);

    function onDeviceReady() {

    }

    function newTrip() {
        alarmOff();
        stationDepartAbbr = $("#select-depart option:selected").val();
        stationArriveAbbr = $("#select-arrive option:selected").val();
        $('#departTime').show();
        $('.arriveTime').hide();
        if (stationDepartAbbr.length > 0 && stationArriveAbbr.length > 0) {
            $('#departProgress').show();
            tripTime = getTripTime(stationDepartAbbr, stationArriveAbbr, getCurrentTimeHHMMSS());
            log("Stations changed in newTrip() from: " + stationDepartAbbr + " leaving: " + formatDateToTime(departTime) + " to: " + stationArriveAbbr + " arriving: " + formatDateToTime(arriveTime) + ") Time=" + tripTime/60 + " minutes");
            $('#departProgress').hide();
            if (tripTime != null) {
                $('#departTime').html(formatDateToTime(departTime)).show();
                $('.arriveTime').html(formatDateToTime(arriveTime)).show();
            }
        }
    }

    //**************** utilities **************************************************


    function log(msg) {
        if (isDebug) {
            if ($('#log').is(':visible') )
                $('#log').append("<br/>" + getCurrentTime() + " - " + msg);
            else
                console.log(getCurrentTime() + " - " + msg);
        }
    }

    function clearLog(msg) {
        $('#log').html("Cleared.");
    }



    function getCurrentTime() {
        var currentTime = new Date();
        var hours = currentTime.getHours();
        var minutes = currentTime.getMinutes();
        var seconds = currentTime.getSeconds();
        if (minutes < 10) {
            minutes = "0" + minutes;
        }
        if (seconds < 10) {
            seconds = "0" + seconds;
        }
        var time="";
        if(hours > 11){
            time = (hours - 12) + ":" + minutes + ":" + seconds + " ";
            time +=" PM";
        } else {
            time = hours + ":" + minutes + ":" + seconds + " ";
            time += " AM";
        }
        return time;
    }

    function getCurrentTimeHHMMSS() {
        var currentTime = new Date();
        var hours = currentTime.getHours();
        var minutes = currentTime.getMinutes();
        var seconds = currentTime.getSeconds();
        if (minutes < 10) {
            minutes = "0" + minutes;
        }
        if (seconds < 10) {
            seconds = "0" + seconds;
        }
        time = hours + ":" + minutes + ":" + seconds + " ";
        return time;
    }

    //times are assumed in hh:mm:ss format
    //returns in seconds
    function timeDiff(time1, time2) {
        var time1ss = HMStoSec1(time1);
        var time2ss = HMStoSec1(time2);
        var diffss = (time2ss - time1ss);
        var diffmm =  diffss / 60;
        log("Time diff = " + diffmm + " minutes");
        return diffss;
    }

    //takes in hh:mm:ss and returns seconds
    function HMStoSec1(T) { // h:m:s
        var A = T.split(/\D+/) ;
        return (A[0]*60 + +A[1])*60 + +A[2];
    }

    //adds specified number of seconds to the time hh:mm:ss
    function addToTime(time, addSeconds) {

    }
    //*********** CSV - GTFS ***************************************************************
    //currently data is located local in /gtfs
    //
    //loads a massive file of times by sched, origin, dest
    function loadStopTimes() {
        //trip_id,arrival_time,departure_time,stop_id,stop_sequence,stop_headsign,pickup_type,drop_off_type
    //    var csvfile = "gtfs/stop_times_test.txt";
        log("loading gtfs stoptimes...");
        $.ajax({
            url : stopTimesFilenameURL,
            dataType : "text",
            success : function (data) {
                arrayStopTimes = jQuery.csv()(data);
            }
        });
        log("   gtfs stoptimes loaded.");
    }

    function loadStations() {
        var abbr = "?";
        var name = "?";
        var options = "";
        var csvfile = "gtfs/stops.txt";
        log("loading gtfs stations...");
        $.ajax({
            url : csvfile,
            dataType : "text",
            async : false,
            success : function (data) {
                arrayStations = jQuery.csv()(data);
                //alert("length:" + arrayStations.length);
            }
        });

        //load the <select> for origin and destination
        options += '<option selected="selected" value="' + "" + '">' + "   " + '</option>';
        for (i=1; i < arrayStations.length; i++) {
            station = arrayStations[i];
            abbr = station[0];
            name = station[1];
            options += '<option value="' + abbr + '">' + name + '</option>';
        }
        log("   gtfs stations loaded.");
        $('#select-depart').html(options);
        $('#select-arrive').html(options);
    }



    //looks in arrayStopTimes to find orig and dest and returns time
    function getTripTime(orig, dest, currentTime ) {
        log("finding trip time for orig:" + orig + "   dest:" + dest + "   currentTime: " + currentTime);
        if (orig == null || dest == null || orig == "" || dest == "" || dest == orig)
            return;
        departTime = null;
        arriveTime = null;
        var now = new Date();
        var dayNames = new Array("SUN","MON","TUE","WED","THU","FRI","SAT");
        var day = dayNames[now.getDay()];

        var stopTimeTripId;
        var currentTripId;
        var origSequence=0;
        var stopTimeSequence;
        var stopTimeStopId;
        var inRoute = false;
        var inRouteDepartTime;
        var stopTime = [];
        var stopTimeDepartTime = "";
        var stopTimeDepartTimeAsDate = new Date();
        var mm = $.trim(now.getMonth() + 1);//zero based for some bizarre reason
        if (mm.length == 1)
            mm = "0" + mm;
        var dd = $.trim(now.getDate());
        if (dd.length == 1)
            dd = "0" + dd;
        //trip_id,arrival_time,departure_time,stop_id,stop_sequence,stop_headsign,pickup_type,drop_off_type
        //Look in stop times for a match to orig, then find dest where it is in same trip and
        //sequence is higher and departure time is closest prior to current time
        var timeString = "";
        log("current time is " + currentTime + "  and the day is " + day);
        for (i=0; i < arrayStopTimes.length; i++) {
            stopTime = arrayStopTimes[i];
            stopTimeTripId = stopTime[0];
            stopTimeDepartTime = stopTime[1];//arrival_time, when they are at station
            if (stopTimeDepartTime.length == 7)
                stopTimeDepartTime = "0" + stopTimeDepartTime;//javascript requires hh format or craps out
            timeString = now.getFullYear() + "-" + mm + "-" + dd + "T" + stopTimeDepartTime;
            stopTimeDepartTimeAsDate = new Date(Date.parse(timeString));
            stopTimeStopId = stopTime[3];
            stopTimeSequence = stopTime[4];
            log("StopTimes record " + i + " - " + "   trip_id: " + stopTimeTripId + "  station: " + stopTimeStopId + "  time:" + stopTime[1] + "  sequence: " + stopTimeSequence);
            if ((stopTimeTripId.indexOf("SUN") >= 0 && day == "SUN")  //its sunday
                    || (stopTimeTripId.indexOf("SAT") >= 0 && day == "SAT") //its saturday
                    || (stopTimeTripId.indexOf("SAT") < 0 && stopTimeTripId.indexOf("SUN") < 0)) {//weekday
                if (stopTimeStopId == orig) { //matching origin
                    if (stopTimeDepartTimeAsDate < now  //previous to current time
                            && stopTimeDepartTimeAsDate > departTime) {//more recent the current match
                        inRoute = true;
                        origSequence = stopTimeSequence;
                        currentTripId = stopTimeTripId;
                        inRouteDepartTime = stopTimeDepartTimeAsDate;
                        log("   Orig found, sequence is " + origSequence + " trip id " + currentTripId + "  time " + departTime);
                    }
                } else {
                    if (stopTimeTripId != currentTripId || parseInt(stopTimeSequence) < parseInt(origSequence)) {
                        log("   station rejected");
                        //if (stopTimeSequence < origSequence)
                            //log("dest rejected because of sequence  " + stopTimeTripId + "  " + currentTripId + "  curr seq=" + stopTimeSequence + "  orig seq=" + origSequence)
                        currentTripId = stopTimeTripId;
                        inRoute = false;
                    } else {
                        log("station not rejected");
                        if (inRoute) {
                            log("in route");
                            if (stopTimeStopId == dest) {
                                arriveTime = stopTimeDepartTimeAsDate;//remember the Date
                                departTime = inRouteDepartTime;
                                log("   Trip found starting at " + departTime + "   arriving at " + arriveTime + "   trip_id: " + stopTimeTripId)
                                inRoute = false;//keep looking for better times
                                //break;
                            }
                        }
                    }
                }
            } //else
        }
        if (arriveTime != null && departTime != null) {
            log("Trip found starting at " + departTime + "   arriving at " + arriveTime)
            return (arriveTime - departTime)/1000;//in seconds
    //                    return (timeDiff(origTime, destTime))
        } else {
            log("ERROR - No trip found.");
            alert("ERROR - Could not find a trip in the BART schedule.");
            return null;
        }
        log("getTripTime done.");
    }


    //****** START - ALARM STUFF *******************
    //alert
    function alarm() {
        log("ALARM, type: " + alarmType);
        navigator.notification.alert("Wakey, wakey, you are approaching your station.",
                alarmCallback(), "Wakey", "Okie Dokie");
        if (alarmType == 1 || alarmType == 3) {
            //navigator.notification.beep(5);
            playStream(alarmFileURL);
        }
        if (alarmType == 2 || alarmType == 3) {
            navigator.notification.vibrate(5000);
        }
    }

    //check if ok to turn alarm on
    function alarmable() {
        if (stationDepartAbbr == "") {
            alert("You need an Departing Station");
            alarmOff();
            return false;
        }
        if (stationArriveAbbr == "") {
            alert("You need an Arriving Station");
            alarmOff();
            return false;
        }

        return true;
    }

    function alarmOn() {
        if (alarmable()) {
            log("alarm ON");
            $('#alarmStatus').show();
            //departTime = new Date();//TODO: Setting departTime to current time for now
            //arriveTime = new Date();
            //arriveTime.setTime(departTime.getTime() + (tripTime * 1000));//tripTime is in seconds
            log("  departTime = " + formatDateToTime(departTime) + "  arrive:" + formatDateToTime(arriveTime));
            timeout=setTimeout(function(){updateAlarmDisplay()},1000);
        }
    }

    //called via setTimout every second
    function updateAlarmDisplay() {
        //log("updateAlarm()")
        $('.arriveTime').html(formatDateToTime(arriveTime));
        var diff = (arriveTime.getTime() - new Date().getTime()) ;

        $('#timeRemaining').html(formatMilliseconds(diff));
        $('#progressbar').val(diff / tripTime);
        if (diff < MINUTES_BEFORE_ARRIVAL * 1000 * 60) {
            //if (diff < 0)
            //    $('#timeRemaining').html("ARRIVED");
            //else
            log(" time remaining less than " + MINUTES_BEFORE_ARRIVAL);
            alarm();
        } else {
            timeout=setTimeout(function(){updateAlarmDisplay()},5000);
        }
    }

    function alarmOff() {
        log("alarmOff() start");
        clearTimeout(timeout);
        $('#alarmStatus').hide();
        $('#radio-alarm-on').removeAttr('checked').checkboxradio("refresh");
        $('#radio-alarm-off').attr('checked',true).checkboxradio("refresh");
        log("alarmOff() complete.");
        if (alarmAudio != null)
            alarmAudio.pause();
    }

    //formats a date into hh:mm:ss
    function formatDateToTime(date) {
        var ampm;
        if (date == null)
            return date;
        var h=date.getHours();
        if (h > 11) {
            ampm = "PM";
            if (h > 12)
                h = h - 12;
        } else
            ampm = "AM";
        var m=date.getMinutes();
        var s=date.getSeconds();
        // add a zero in front of numbers<10
        m=padTime(m);
        s=padTime(s);
        return h + ":" + m + " " + ampm;
    }

    function formatMilliseconds(ms) {
        var x = ms / 1000;
        var seconds = x % 60;
        x /= 60;
        minutes = x % 60;
        minutes = Math.floor(minutes);
        x /= 60;
        hours = x % 24;
        hours = Math.floor(hours);
        x /= 2;
        var result = "";
        if (hours > 0)
            result = hours + " hrs ";
        result += minutes + " min ";
        return result;
    }

    function padTime(i) {
        if (i<10)
            i="0" + i;
        return i;
    }

    function alarmCallback() {
        //cancel alarm?
        //alarmAudio.pause();
    }
    //****** END - ALARM STUFF *******************

    //****** START - Audio
    function playStream(url) {
        log("playStream of:" + url);
        try {
            alarmAudio = new Audio(url);
            alarmAudio.id = 'alarmAudio';
            alarmAudio.addEventListener('ended', function() {
                this.currentTime = 0;
                this.play();
            }, false);
            alarmAudio.play();
        } catch (e) {
            alert('no audio support!');
        }
        log("playStream complete.");
    }

    //******** END - audio



    //********** GPS STUFF *****************************************************************
    // onSuccess Geolocation
    //
    function getGeo() {
        //log("calling geolocation.getCurrentPosition...");
        //navigator.geolocation.getCurrentPosition(onGeoSuccess, onGeoError);
        //log("geolocation.getCurrentPosition complete.");
        //
        // Options: throw an error if no update is received every 30 seconds.
        //
        //var watchID = navigator.geolocation.watchPosition(onWatchSuccess, onWatchError, { timeout: 30000 });
    }


    //function onGeoSuccess(position) {
    //    var element = document.getElementById('geolocation');
    //    element.innerHTML = 'Latitude: ' + position.coords.latitude            + '<br />' +
    //            'Longitude: '          + position.coords.longitude             + '<br />' +
    //            'Altitude: '           + position.coords.altitude              + '<br />' +
    //            'Accuracy: '           + position.coords.accuracy              + '<br />' +
    //            'Altitude Accuracy: '  + position.coords.altitudeAccuracy      + '<br />' +
    //            'Heading: '            + position.coords.heading               + '<br />' +
    //            'Speed: '              + position.coords.speed                 + '<br />' +
    //            'Timestamp: '          + position.timestamp                    + '<br />';
    //}
    //
    //// onError Callback receives a PositionError object
    ////
    //function onGeoError(error) {
    //    alert('code: '    + error.code    + '\n' +
    //            'message: ' + error.message + '\n');
    //}


    // onSuccess Callback
    //   This method accepts a `Position` object, which contains
    //   the current GPS coordinates
    //
//    function onWatchSuccess(position) {
//        var element = document.getElementById('geolocation');
//        element.innerHTML = 'Latitude: '  + position.coords.latitude      + '<br />' +
//                'Longitude: ' + position.coords.longitude     + '<br />' +
//                '<hr />'      + element.innerHTML;
//    }
//
//    // onError Callback receives a PositionError object
//    //
//    function onWatchError(error) {
//        alert('code: '    + error.code    + '\n' +
//                'message: ' + error.message + '\n');
//    }
    //********** END - GPS STUFF *****************************************************************




</script>
</head>
<body>
<section id="page1" data-role="page" data-fullscreen="true">
    <header data-role="header" ZZdata-position="fixed"><h1>BART Nap App</h1></header>
    <div class="content" data-role="content">
        <div style="float:right">
            <a href="#pageMap"  data-rel="dialog">BART Map</a>
        </div>
        <div style="margin-top: 20px; width:320px;">
            <div  style="height: 10px;" ondblclick="$('#debugLog').toggle();">
                <!--<label for="select-depart" ondblclick="$('#debugLog').show();">Start</label>-->
                <div style="float:left;height: 10px">Start</div>
                <div style="float:right;height: 10px;font-size: 12px;color: #8b4513;">
                    <span id="departProgress" >Searching...</span>
                    <span style="font-size: 12px;color: #8a2be2;" id="departTime" ></span>
                </div>
            </div>

            <div  style="" data-role="fieldcontain">
                <select id="select-depart" name="select-depart">
                </select>
            </div>
        </div>
        <div style="">
            <div  style="height: 10px;">
                <div style="float:left;height: 10px">End</div>
                <div style="float:right;height: 10px;">
                    <span class="arriveTime" style="font-size: 12px;color: #8b4513;"></span>
                </div>
            </div>
            <div style="" data-role="fieldcontain">
                <select id="select-arrive" name="select-arrive">
                </select>
            </div>
        </div>
        <fieldset id="alarmtype" style="" data-role="controlgroup" data-type="horizontal">
            <!--<div style="">Alarm Type</div>-->
            <!--<div>-->
                <input  style="" type="radio" name="radio-alarmtype" id="radio-alarmtype-noise" value="choice-alarmtype-noise" checked="checked" />
                <label for="radio-alarmtype-noise" style="width:95px;">Alarm</label>
                <input type="radio" name="radio-alarmtype" id="radio-alarmtype-vibrate" value="choice-alarmtype-vibrate"  />
                <label for="radio-alarmtype-vibrate" style="width:95px;">Vibrate</label>
                <input type="radio" name="radio-alarmtype" id="radio-alarmtype-both" value="choice-alarmtype-both"  />
                <label for="radio-alarmtype-both" style="width:95px;">Both</label>
            <!--</div>-->
        </fieldset>


        <div data-role="fieldcontain" style="">
            <!--<div style="float:left;margin-top:10px;">ON / OFF</div>-->
            <fieldset id="radio-alarm-state" data-role="controlgroup" data-type="horizontal">
                <!--<legend>Alarm:</legend>-->
                <input type="radio" name="radio-alarm-state" id="radio-alarm-on">
                <label for="radio-alarm-on"  style="color:green;width:142px;">Alarm ON</label>
                <input type="radio" name="radio-alarm-state" id="radio-alarm-off" checked="checked">
                <label for="radio-alarm-off" style="color:red;width:142px;">Alarm OFF</label>
            </fieldset>
        </div>

<!--

        <div id="alarmStatus" style="border: solid #828282; border-radius: 15px; text-align: center">
            &lt;!&ndash;Projected Arrival Time <span id="arriveTime">?</span>&ndash;&gt;
            &lt;!&ndash;<br />&ndash;&gt;
            <span id="timeRemaining" style="font-size: 32px;">??:??</span>
            <div id="progressbar"></div>
        </div>

-->
        <div id="alarmStatus" style="height: 100px;">
            <a id="timeRemaining" href="#" data-role="button" data-icon="star" data-theme="e"></a>
        </div>

        <!--<button value="zzzz" style="height: 160px;">Projected Arrival Time<br/>4:34 </button>-->

        <div id="debugLog" style="font-size: 10px; color: #C97917;background-color: #fff9df;" data-role="collapsible">
            <h3>Debug Log</h3>
            <a href="#pageDebug">debug</a>&nbsp;&nbsp;&nbsp;
            <a href="#"  onclick="clearLog();">Clear</a>&nbsp;&nbsp;&nbsp;
            <a href="#" onclick="getBartStations();">Load Stations</a>&nbsp;&nbsp;&nbsp;
            <a href="#" onclick="loadStopTimes();">Load Stop Times</a>&nbsp;&nbsp;&nbsp;
            <a href="#" onclick="getTripTime(stationDepartAbbr,stationArriveAbbr,getCurrentTimeHHMMSS());">Trip Time</a>&nbsp;&nbsp;&nbsp;
            <a href="#" onclick="alarm();">Alarm</a>&nbsp;&nbsp;&nbsp;
            <a href="#" onclick="alarmOff();">Alarm Off</a>&nbsp;&nbsp;&nbsp;
            <div id="log"  style="height: 200px;overflow: scroll;overflow-x:hidden;background-color: #111111; font-size: 12px; color: #C6E746;"></div>
        </div>
    </div>
    <!--<footer data-role="footer"><h1>MTS</h1></footer>-->
</section>

<section id="pageMap" data-role="page">
    <header data-role="header"><h1>BART Map</h1></header>
    <div class="content" data-role="content">
        <p><img src="assets/img/system-map.gif"></p>
    </div>
    <footer data-role="footer" ZZdata-position="fixed"><h1>MTS</h1></footer>
</section>

<section id="pageDebug" data-role="page">
    <header data-role="header"><h1>Debug Page</h1></header>
    <div class="content" data-role="content">
        <div id="geolocation">
        </div>
        <a href="#" id="" onclick="alarm()">Alarm</a>
    </div>
    <!--<footer data-role="footer" ZZdata-position="fixed"><h1>MTS</h1></footer>-->
</section>

<!--Uncomment below to send debug to Phonegap Build site-->
<!--<script type="text/javascript" src="http://debug.phonegap.com/target/target-script-min.js#69d930ba-da73-11e1-9ed2-1231391c98a7"></script>-->
</body>

</html>